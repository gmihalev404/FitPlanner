<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:class="${theme != null ? theme : 'dark'}"
      th:lang="${language != null ? language : 'en'}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="#{create.workout}">Create Workout</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <link rel="stylesheet" th:href="@{/css/common.css(v=${#dates.createNow().time})}">
  <link rel="stylesheet" th:href="@{/css/navbar.css(v=${#dates.createNow().time})}">
  <link rel="stylesheet" th:href="@{/css/footer.css(v=${#dates.createNow().time})}">
  <link rel="stylesheet" th:href="@{/css/scrollbar.css(v=${#dates.createNow().time})}">
  <link rel="stylesheet" th:href="@{/css/dark-theme.css(v=${#dates.createNow().time})}">
  <link rel="stylesheet" th:href="@{/css/light-theme.css(v=${#dates.createNow().time})}">
  <link rel="stylesheet" th:href="@{/css/search-bar.css(v=${#dates.createNow().time})}">
  <link rel="stylesheet" th:href="@{/css/create-workout.css(v=${#dates.createNow().time})}">
</head>
<body>
<div th:replace="~{fragment/navbar.html::navbar}"></div>

<div class="background-section py-4">
  <div class="container create-workout-log p-4">
    <h1 class="container-heading text-center mb-5">Create Workout</h1>

    <form id="programForm"
          th:action="${programId == null} ? @{'/create-full-workout'} : @{'/edit-program'}"
          th:object="${programForm}"
          method="post"
          enctype="multipart/form-data">
      <input type="hidden" th:field="*{imageUrl}" id="hiddenImageUrl">
      <div class="row g-4 mb-5 align-items-stretch">
        <div class="col-12 col-md-4">
          <label class="form-label fw-bold">Program Image</label>
          <div class="custom-file-upload h-100 d-flex flex-column">
            <div class="mb-2 text-center border rounded p-2 flex-grow-1 d-flex align-items-center justify-content-center"
                 style="background: rgba(255,255,255,0.05); height: 200px; width: 100%; overflow: hidden; border: 1px dashed rgba(255,255,255,0.2);">

              <img id="previewImg" th:src="${programForm.imageUrl != null ? programForm.imageUrl : '#'}"
                   alt="Preview"
                   th:style="${programForm.imageUrl != null ? 'width: 100%; height: 100%; object-fit: cover; display: block; border-radius: 4px;' : 'display: none;'}">

              <i id="uploadIcon" class="bi bi-image text-muted"
                 th:style="${programForm.imageUrl != null ? 'display: none;' : 'font-size: 3.5rem;'}"></i>
            </div>
            <input type="file" name="programImage" id="programImage" class="form-control" accept="image/*">
            <div class="form-text small">Max size: 2MB (JPG, PNG)</div>
          </div>
        </div>

        <div class="col-12 col-md-8">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label fw-bold" th:text="#{create.program_name}">Program Name</label>
              <input type="text" th:field="*{name}" class="form-control form-control-lg bg-input color-main" required>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label fw-bold" th:text="#{create.schedule}">Schedule</label>
              <select class="form-select bg-input color-main" th:field="*{scheduleMonths}">
                <option th:value="1" th:text="'1 ' + #{create.month}">1 Month</option>
                <option th:value="3" th:text="'3 ' + #{create.months}">3 Months</option>
                <option th:value="6" th:text="'6 ' + #{create.months}">6 Months</option>
              </select>
            </div>

            <div class="col-12 col-md-6 d-flex align-items-end">
              <div class="d-flex align-items-center rounded p-2 w-100"
                   style="height: 38px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                <div class="form-check me-4">
                  <input type="checkbox" th:field="*{notifications}" class="form-check-input" id="notify">
                  <label class="form-check-label fw-bold mb-0" for="notify" th:text="#{create.notify}">Notify</label>
                </div>
                <div class="form-check">
                  <input type="checkbox" th:field="*{isPublic}" class="form-check-input" id="public">
                  <label class="form-check-label fw-bold mb-0" for="public" th:text="#{create.public}">Public</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>

    <div class="position-relative mt-4">
      <button id="leftArrow" class="nav-arrow" type="button" aria-label="Scroll left">&#8592;</button>
      <button id="rightArrow" class="nav-arrow" type="button" aria-label="Scroll right">&#8594;</button>

      <div id="daysContainer" class="row g-4 flex-nowrap overflow-hidden">
        <div th:each="dayWorkout : ${weekDays}" class="col-12 col-md-4 col-xl-3 scroll-snap-item">
          <div class="card h-100 glass-panel">
            <div class="card-body p-3 d-flex flex-column">
              <h5 class="fw-bold text-center text-uppercase border-bottom pb-2 mb-3"
                  th:text="${#messages.msg(dayWorkout.day.toLowerCase())}"></h5>

              <div th:if="${dayWorkout.exercises.isEmpty()}" class="text-center p-4">
                <img th:src="@{/images/coffee.jpg}" class="coffee-img img-fluid rounded" th:alt="#{create.rest_day}">
              </div>

              <div th:unless="${dayWorkout.exercises.isEmpty()}" class="max-vh-25 d-flex flex-column w-100 overflow-auto">
                <div th:each="exercise : ${dayWorkout.exercises}" class="exercise-item bg-light p-2 rounded mb-2 border-start border-4 border-success d-flex justify-content-between align-items-center w-100">
                  <div class="flex-grow-1 overflow-hidden">
                    <div class="fw-bold small text-dark text-truncate" th:text="${exercise.name}"></div>
                    <div class="text-muted" style="font-size: 0.7rem;"
                         th:text="${exercise.sets + ' ' + #messages.msg('create.sets') + ' - ' + exercise.reps + ' x '
                                             + exercise.weight + ' ' + (programsUserDto.measuringUnits == 'kg' ? 'kg' : 'lbs')}">
                    </div>
                  </div>
                  <div class="d-flex align-items-center ms-2">
                    <form th:action="@{/edit-exercise}" method="get" class="me-1">
                      <input type="hidden" name="day" th:value="${dayWorkout.day}">
                      <input type="hidden" name="id" th:value="${exercise.id}">
                      <button type="submit" class="btn btn-sm text-primary p-0 px-1" title="Edit">&#9998;</button>
                    </form>
                    <form th:action="@{/remove-exercise}" method="post">
                      <input type="hidden" name="day" th:value="${dayWorkout.day}">
                      <input type="hidden" name="id" th:value="${exercise.id}">
                      <button type="submit" class="btn btn-sm text-danger p-0 px-1">âœ•</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-footer bg-transparent border-0 p-3 mt-auto">
              <form th:action="@{/exercise-log}" method="get">
                <input type="hidden" name="day" th:value="${dayWorkout.day}">
                <button type="submit" class="btn btn-outline-success w-100 fw-bold btn-sm rounded-pill" th:text="#{create.add_exercise}">+ Add Exercise</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-5">
      <button form="programForm" type="submit" class="btn bg-success btn-lg px-5 shadow rounded-pill fw-bold text-white"
              th:text="${programId == null} ? #{create.submit} : #{create.update}">CREATE PROGRAM</button>
    </div>
  </div>
</div>

<footer th:replace="~{fragment/footer.html::footer}"></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/update-program-session.js(v=${#dates.createNow().time})}"></script>
<script th:src="@{/js/scrollable-days.js(v=${#dates.createNow().time})}"></script>
<script th:src="@{/js/search-bar.js(v=${#dates.createNow().time})}"></script>
<script th:src="@{/js/notifications.js(v=${#dates.createNow().time})}" defer></script>

<script>
  document.getElementById('programImage').addEventListener('change', function(event) {
    const file = this.files[0];
    const preview = document.getElementById('previewImg');
    const icon = document.getElementById('uploadIcon');
    // This is the hidden input field we will update
    const hiddenInput = document.getElementById('hiddenImageUrl');

    if (file) {
      // 1. Instant Local Preview (for the user to see immediately)
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
        if(icon) icon.style.display = 'none';
      }
      reader.readAsDataURL(file);

      // 2. Session Upload via AJAX
      const formData = new FormData();
      formData.append('programImage', file);

      fetch('/upload-program-image-session', {
        method: 'POST',
        body: formData
      })
              .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.text();
              })
              .then(url => {
                if (url !== "error") {
                  console.log("Image saved to session:", url);

                  // 3. SYNC: Update the hidden input field.
                  // This ensures the final form POST sends the NEW image path.
                  if (hiddenInput) {
                    hiddenInput.value = url;
                  }
                } else {
                  alert("Server error uploading image.");
                }
              })
              .catch(err => {
                console.error("Session upload failed:", err);
                alert("Failed to upload image to server.");
              });
    }
  });
</script>
</body>
</html>