<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:class="${theme != null ? theme : 'dark'}"
      th:lang="${language != null ? language : 'en'}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="#{create.workout.title}">FitPlanner | Create Workout</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <link rel="stylesheet" th:href="@{/css/common.css(v=${#dates.createNow().time})}">
  <link rel="stylesheet" th:href="@{/css/navbar.css(v=${#dates.createNow().time})}">
  <link rel="stylesheet" th:href="@{/css/footer.css(v=${#dates.createNow().time})}">
  <link rel="stylesheet" th:href="@{/css/scrollbar.css(v=${#dates.createNow().time})}">
  <link rel="stylesheet" th:href="@{/css/dark-theme.css(v=${#dates.createNow().time})}">
  <link rel="stylesheet" th:href="@{/css/light-theme.css(v=${#dates.createNow().time})}">
  <link rel="stylesheet" th:href="@{/css/search-bar.css(v=${#dates.createNow().time})}">
  <link rel="stylesheet" th:href="@{/css/create-workout.css(v=${#dates.createNow().time})}">
</head>
<body>
<div th:replace="~{fragment/navbar.html::navbar}"></div>

<div class="background-section py-4">
  <div class="container create-workout-log p-4">
    <h1 class="container-heading text-center mb-5" th:text="#{create.workout.heading}">Create Workout</h1>

    <form id="programForm"
          th:action="${programId == null} ? @{'/create-full-workout'} : @{'/edit-program'}"
          th:object="${programForm}"
          method="post"
          enctype="multipart/form-data">

      <input type="hidden" th:field="*{imageUrl}" id="hiddenImageUrl">

      <div class="row g-4 mb-5 align-items-stretch">
        <div class="col-12 col-md-4">
          <label class="form-label fw-bold" th:text="#{create.label.program_image}">Program Image</label>
          <div class="custom-file-upload h-100 d-flex flex-column">
            <div id="imagePreviewContainer" class="mb-2 text-center border rounded p-2 flex-grow-1 d-flex align-items-center justify-content-center"
                 style="background: rgba(255,255,255,0.05); min-height: 200px; width: 100%; overflow: hidden; border: 1px dashed rgba(255,255,255,0.2);">

              <img th:src="${programForm.imageUrl != null ? programForm.imageUrl : ''}"
                   th:classappend="${#strings.isEmpty(programForm.imageUrl)} ? 'hidden' : ''"
                   class="preview-image"
                   id="previewImgTag"
                   alt="Preview">

              <i th:if="${#strings.isEmpty(programForm.imageUrl)}"
                 class="bi bi-image text-muted"
                 style="font-size: 3.5rem;"></i>
            </div>
            <input type="file" name="programImage" id="programImage" class="form-control" accept="image/*">
            <div class="form-text small" th:text="#{create.image.max_size}">Max size: 2MB (JPG, PNG)</div>
          </div>
        </div>

        <div class="col-12 col-md-8">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label fw-bold" th:text="#{create.program_name}">Program Name</label>
              <input type="text" th:field="*{name}" id="prog-name" class="form-control form-control-lg bg-input color-main"
                     th:placeholder="#{create.placeholder.program_name}" required>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label fw-bold" th:text="#{create.schedule}">Schedule</label>
              <select class="form-select bg-input color-main" th:field="*{scheduleMonths}" id="prog-months">
                <option th:value="1" th:text="'1 ' + #{create.month}">1 Month</option>
                <option th:value="3" th:text="'3 ' + #{create.months}">3 Months</option>
                <option th:value="6" th:text="'6 ' + #{create.months}">6 Months</option>
              </select>
            </div>

            <div class="col-12 col-md-6 d-flex align-items-end">
              <div class="d-flex align-items-center rounded p-2 w-100"
                   style="height: 38px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);">
                <div class="form-check me-4">
                  <input type="checkbox" th:field="*{notifications}" class="form-check-input" id="notify">
                  <label class="form-check-label fw-bold mb-0" for="notify" th:text="#{create.notify}">Notify</label>
                </div>
                <div class="form-check">
                  <input type="checkbox" th:field="*{isPublic}" class="form-check-input" id="public">
                  <label class="form-check-label fw-bold mb-0" for="public" th:text="#{create.public}">Public</label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>

    <div class="position-relative mt-4">
      <button id="leftArrow" class="nav-arrow" type="button">&#8592;</button>
      <button id="rightArrow" class="nav-arrow" type="button">&#8594;</button>

      <div id="daysContainer" class="row g-4 flex-nowrap overflow-hidden">
        <div th:each="dayWorkout : ${weekDays}" class="col-12 col-md-4 col-xl-3 scroll-snap-item">
          <div class="card h-100 glass-panel">
            <div class="card-body p-3 d-flex flex-column">
              <h5 class="fw-bold text-center text-uppercase border-bottom pb-2 mb-3"
                  th:text="${#messages.msg(dayWorkout.day.toLowerCase())}"></h5>

              <div th:if="${dayWorkout.exercises.isEmpty()}" class="text-center p-0">
                <img th:src="@{/images/coffee.jpg}" class="coffee-img img-fluid rounded-top w-100" th:alt="#{create.rest_day}">

                <div class="py-2 rounded-bottom">
                  <p class="m-0 fw-bold text-uppercase small"
                     th:text="#{create.rest_day}">
                    Rest Day
                  </p>
                </div>
              </div>

              <div th:unless="${dayWorkout.exercises.isEmpty()}" class="max-vh-25 d-flex flex-column w-100 overflow-auto">
                <div th:each="exercise : ${dayWorkout.exercises}" class="exercise-item bg-light p-2 rounded mb-2 border-start border-4 border-success d-flex justify-content-between align-items-center w-100">
                  <div class="flex-grow-1 overflow-hidden">
                    <div class="fw-bold small text-dark text-truncate" th:text="${exercise.name}"></div>
                    <div class="text-muted" style="font-size: 0.7rem;"
                         th:text="${exercise.sets + ' ' + #messages.msg('create.sets') + ' - ' + exercise.reps + ' x '
                                             + exercise.weight + ' ' + (programsUserDto.measuringUnits == 'kg' ? #messages.msg('unit.kg') : #messages.msg('unit.lbs'))}">
                    </div>
                  </div>
                  <div class="d-flex align-items-center ms-2">
                    <form th:action="@{/edit-exercise}" method="get" class="me-1 sync-required">
                      <input type="hidden" name="day" th:value="${dayWorkout.day}">
                      <input type="hidden" name="id" th:value="${exercise.id}">
                      <button type="submit" class="btn btn-sm text-primary p-0 px-1" th:title="#{create.btn.edit}">&#9998;</button>
                    </form>
                    <form th:action="@{/remove-exercise}" method="post" class="sync-required">
                      <input type="hidden" name="day" th:value="${dayWorkout.day}">
                      <input type="hidden" name="id" th:value="${exercise.id}">
                      <button type="submit" class="btn btn-sm text-danger p-0 px-1" th:title="#{create.btn.remove}">âœ•</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            <div class="card-footer bg-transparent border-0 p-3 mt-auto">
              <form th:action="@{/exercise-log}" method="get" class="sync-required">
                <input type="hidden" name="day" th:value="${dayWorkout.day}">
                <button type="submit" class="btn btn-outline-success w-100 fw-bold btn-sm rounded-pill" th:text="#{create.add_exercise}">+ Add Exercise</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mt-5">
      <button form="programForm" type="submit" class="btn bg-success btn-lg px-5 shadow rounded-pill fw-bold text-white"
              th:text="${programId == null} ? #{create.submit} : #{create.update}">CREATE PROGRAM</button>
    </div>
  </div>
</div>

<footer th:replace="~{fragment/footer.html::footer}"></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/upload-file.js(v=${#dates.createNow().time})}"></script>
<script th:src="@{/js/scrollable-days.js(v=${#dates.createNow().time})}"></script>
<script th:src="@{/js/search-bar.js(v=${#dates.createNow().time})}"></script>
<script th:src="@{/js/notifications.js(v=${#dates.createNow().time})}" defer></script>
<script th:src="@{/js/sync-program-data.js}"></script>
<script>
  document.getElementById('programImage').addEventListener('change', function() {
    FileUploader.previewAndUpload(this, {
      containerSelector: '#imagePreviewContainer',
      hiddenInputId: 'hiddenImageUrl',
      uploadUrl: '/upload-program-image-session',
      paramName: 'programImage'
    });
  });
</script>
</body>
</html>